# This is a basic workflow to help you get started with Actions

name: Scrape data

# Controls when the action will run.
on:
  repository_dispatch:
    types: rescrape
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  data_scraper:
    name: "Scrape All Data"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout scrapers
        uses: actions/checkout@v2
        with:
          path: 'quacs-oxy-scraper'
          repository: 'NickyBoy89/quacs-oxy-scraper'

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.x'

      - name: Setup pip requirements
        run: |
          sudo apt-get install -y libxml2 libxml2-dev libxslt-dev
          python -m pip install --upgrade pip
          pip install -r quacs-oxy-scraper/requirements.txt
          ls

      - name: Get semesters
        run: |
          python3 quacs-oxy-scraper/semesters/main.py

      - name: Scrape schools
        run: |
          python3 quacs-oxy-scraper/school_scraper/main.py

      - name: Scrape catalog
        run: |
          python3 quacs-oxy-scraper/catalog_scraper/main.py

      - name: Scrape faculty directory
        run: |
          python3 quacs-oxy-scraper/faculty_directory_scraper/main.py

      - name: Scrape prerequisites
        run: |
          python3 quacs-oxy-scraper/prerequisite_scraper/main.py

      - name: Scrape RateMyProfessors
        run: |
          python3 quacs-oxy-scraper/rmp_scraper/main.py

      - name: Scrape SIS
        run: |
          python3 quacs-oxy-scraper/sis_scraper/main.py

      - name: Upload data
        uses: actions/upload-artifact@v2
        with:
          name: courses
          path: |
            courses.json
            mod.rs
            catalog.json
            rmp.json
            prerequisites.json
            faculty.json
            schools.json
  commit-data:
    name: Commit changes
    continue-on-error: true
    runs-on: ubuntu-latest
    needs: [data_scraper]
    steps:
      - name: Checkout data
        uses: actions/checkout@v2
        with:
          path: 'data'
          repository: 'NickyBoy89/quacs-oxy-data'
          clean: true

      - name: Get scraped data
        uses: actions/download-artifact@v2

      - name: Generate meta json file
        run: echo {\"last_updated\":\"$(date --iso-8601=seconds -u)\"} > data/meta.json

      - name: Find whats in the artifact
        run: |
          cd courses
          ls

      - name: Commit new data
        run: |
          current_semester=$(head -n 1 semesters.json)
          echo $current_semester
          cp courses/courses.json courses/mod.rs data/semester_data/${current_semester}
          cp courses/catalog.json data/semester_data/${current_semester}
          cp courses/rmp.json data/semester_data/${current_semester}
          cp courses/prerequisites.json data/semester_data/${current_semester}
          cp courses/schools.json data/semester_data/${current_semester}
          cp courses/faculty.json data
          git config user.name "Nicholas Novak" && git config user.email "nicholasmnovak@gmail.com"
          cd data
          git add faculty.json
          cd semester_data/${current_semester}
          git add courses.json mod.rs
          git add prerequisites.json
          git add schools.json
          git add catalog.json
          git add meta.json
          git commit -m "$(date -u)"
          git push --force
